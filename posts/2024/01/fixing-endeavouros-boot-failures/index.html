<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Fixing EndeavourOS Boot Failures | Edmund Goodman</title>
<meta name=author content="Edmund Goodman"><meta name=description content="The personal website for Edmund Goodman"><meta http-equiv=content-language content="en-uk"><link rel=icon href=/images/favicon.ico sizes=any type=image/x-icon><link rel=stylesheet type=text/css href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.0/font/bootstrap-icons.min.css><link rel=stylesheet type=text/css href=https://edmundgoodman.github.io/css/styles.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.min.js></script><script src=/js/main.js defer></script></head><body><section id=top-nav><nav><span class="nav-item nav-logo"><a href=/ class=nav-link>Home</a></span><ul class=nav-menu><li class="nav-item nav-normal"><a href=/about class=nav-link>About</a></li><li class="nav-item nav-normal"><a href=/posts/ class=nav-link>Blog</a></li><li class="nav-item hamburger-container"><input id=popout-nav-toggle name=popout-nav-toggle class=popout-nav-toggle type=checkbox onclick=changeNav()><div class=hamburger-lines><span class="line line1"></span>
<span class="line line2"></span>
<span class="line line3"></span></div></li></ul></nav></section><div id=popout-nav class=overlay><div class=overlay-content><span><a href=/ class=nav-link>Home</a></span><span><a href=/about class=nav-link>About</a></span>
<span><a href=/posts/ class=nav-link>Blog</a></span></div></div><script>function changeNav(){document.querySelector("input[name=popout-nav-toggle]").checked?document.getElementById("popout-nav").style.width="100%":document.getElementById("popout-nav").style.width="0%"}</script><section id=page-content><header><h1>Fixing EndeavourOS Boot Failures</h1><div class=post-meta><div class=separated-items><span class=separated-item><i class="bi bi-calendar"></i>
<time datetime=2024-01-13>Jan 13, 2024</time>
</span><span class=separated-item><i class="bi bi-clock"></i>4 minutes</span></div></div></header><article><p>This post enumerates a process which worked for me to repair an installation of EndeavourOS with full-disk encryption when it is unable to boot. It is also available <a href=https://gist.github.com/EdmundGoodman/c057ce0c826fd0edde7917d15b709f4f>as a gist</a>.</p><p>Specifically, this set of steps fixed the boot process on a HP-Envy laptop running EndeavourOS with an ext4 file system. The issue normally occurs after an interrupted update using <code>pacman -Syu</code>, which then causes the system to be unable to boot after the next restart (showing only &ldquo;boot to firmware interface&rdquo; in the boot menu).</p><h2 id=steps-to-fix>Steps to fix</h2><h3 id=1-boot-with-an-endeavouros-live-usb-stick>1) Boot with an EndeavourOS live USB stick</h3><p>You will need a live/bootable USB key with EndeavourOS installed on it. The <a href=https://discovery.endeavouros.com/installation/create-install-media-usb-key/2021/03/>EndeavourOS website lists a number of ways to do this</a>
<a href=#footnote--1><sup>[1]</sup></a>
.</p><p>Then, boot the computer from this live USB stick. This normally involves a process similar to:</p><ol><li>Turning off the computer</li><li>Plugging in the USB stick</li><li>Turning on computer, then repeatedly pressing the ESC key, until a boot menu shows up</li><li>Navigate to select the boot device in the boot menu, then select the option to boot from the live USB</li></ol><p>This should drop you into a working EndeavourOS operating system, from which you can run the steps to fix the broken one on the computer. All the next steps are commands to run in a terminal, which can be opened with <code>ctrl+alt+t</code>.</p><p>Additionally, you should connect to a WiFi network on the live boot, as this makes copy-pasting commands from the internet easier &#x1f605;, and allows downloading/completing updates to the broken boot device.</p><h3 id=2-decrypt-and-mount-the-encrypted-and-boot-disk-partitions>2) Decrypt and mount the encrypted and boot disk partitions</h3><p>First, identify your boot and encrypted partitions
<a href=#footnote--2><sup>[2]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>lsblk -f
</span></span></code></pre></div><p>This will list the available devices, from which you need to identify your boot and encrypted partitions. For my particular laptop:</p><ul><li>Encrypted partition = <code>nvme0n1p2</code></li><li>Boot partition = <code>nvme0n1p1</code></li></ul><p>Next, use <code>cryptsetup</code> to decrypt the LUKS encrypted drive
<a href=#footnote--3><sup>[3]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>sudo cryptsetup open /dev/mapper/nvme0n1p2 luks_root
</span></span></code></pre></div><p>Then, mount the newly decrypted partition and then the boot drive into the <code>/boot/</code> folder within it
<a href=#footnote--4><sup>[4]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>sudo mount /dev/mapper/luks_root /mnt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>sudo mount /dev/nvme0n1p1 /mnt/boot
</span></span></code></pre></div><h3 id=3-root-into-the-broken-system>3) Root into the broken system</h3><p><strong>Before this step, it is helpful to have connected to the WiFi on the live boot, as you would on any Linux computer</strong>
<a href=#footnote--5><sup>[5]</sup></a>
.</p><p>Next, use <code>arch-chroot</code> to root into the newly mounted broken system
<a href=#footnote--6><sup>[6]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>arch-chroot /mnt
</span></span></code></pre></div><h3 id=4-debugging-wifi-inside-arch-chroot>4) Debugging WiFi inside <code>arch-chroot</code></h3><p>You can check whether WiFi is working inside <code>arch-chroot</code> using the <code>ping</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>ping google.com
</span></span></code></pre></div><p>If the WiFi doesn&rsquo;t work inside <code>arch-chroot</code> on the broken device, first check if it is working on the live boot. If it isn&rsquo;t, fix it there, then exit and rerun <code>arch-chroot</code>.</p><p>If it still isn&rsquo;t working, the next most likely cause it DNS settings haven&rsquo;t been copied over. To fix this, exit the <code>arch-chroot</code> to unlock the <code>resolv.conf</code> file, add DNS settings, then rerun <code>arch-chroot</code>
<a href=#footnote--7><sup>[7]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>exit
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>echo <span style=color:#e6db74>&#34;nameserver 8.8.8.8&#34;</span> &gt;&gt; /mnt/etc/resolv.conf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>arch-chroot /mnt
</span></span></code></pre></div><h3 id=5-try-to-repair-the-broken-system>5) Try to repair the broken system</h3><p>The common issues I have found across two failures are as follows:</p><ul><li><code>pacman</code> was interrupted during running, so the lock file is still present
<a href=#footnote--8><sup>[8]</sup></a></li><li><code>pacman</code> needs to finish the interrupted upgrade</li><li>linux headers need to be re-installed</li><li><code>grub</code> needs to be re-built
<a href=#footnote--9><sup>[9]</sup></a></li></ul><p>These can be resolved as follows (inside <code>arch-chroot</code> on the broken device):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>sudo rm /var/lib/pacman/db.lck
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>sudo pacman -Syu
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>sudo pacman -Syu linux-lts linux-lts-headers
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>grub install --target<span style=color:#f92672>=</span>x86_54-efi --efi-directory<span style=color:#f92672>=</span>/boot/efi --bootloader-id<span style=color:#f92672>=</span>GRUB
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>It is possible something else is wrong, but this time is when you should largely be running commands to fix it!</p><p>Then, disconnect from the <code>arch-chroot</code> as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>exit
</span></span></code></pre></div><h3 id=6-clean-up-and-try-to-boot>6) Clean up and try to boot</h3><p>Before restarting, it is good practice to unmount both the boot and decrypted partitions, then close the decrypted partition
<a href=#footnote--10><sup>[10]</sup></a>
.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>sudo umount /mnt/boot/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>sudo umount /mnt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>sudo cryptsetup close luks_root
</span></span></code></pre></div><p>Finally, restart the computer, and hope that it boots correctly!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>reboot
</span></span></code></pre></div><h2 id=references>References</h2><ul><li><span id=footnote--1>[1]</span>: <a href=https://discovery.endeavouros.com/installation/create-install-media-usb-key/2021/03/)>https://discovery.endeavouros.com/installation/create-install-media-usb-key/2021/03/)</a></li><li><span id=footnote--10>[10]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#4---unmount-and-exit>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#4---unmount-and-exit</a></li><li><span id=footnote--2>[2]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#mount-luks-partitions-for-system-recovery>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#mount-luks-partitions-for-system-recovery</a></li><li><span id=footnote--3>[3]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#1---open-the-encrypted-disk>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#1---open-the-encrypted-disk</a></li><li><span id=footnote--4>[4]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#2---mount-all-the-partitions>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#2---mount-all-the-partitions</a></li><li><span id=footnote--5>[5]</span>: It doesn&rsquo;t break anything if you don&rsquo;t connect to WiFi. However, if you later need WiFi access on the broken boot device you&rsquo;ll need to exit out, connect to WiFi, and <code>arch-chroot</code> back in if you haven&rsquo;t.</li><li><span id=footnote--6>[6]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#3---root-into-the-new-system>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#3---root-into-the-new-system</a></li><li><span id=footnote--7>[7]</span>: <a href=https://unix.stackexchange.com/a/481862>https://unix.stackexchange.com/a/481862</a></li><li><span id=footnote--8>[8]</span>: <a href=https://forum.endeavouros.com/t/update-problem-var-lib-pacman-db-lck/5239/2>https://forum.endeavouros.com/t/update-problem-var-lib-pacman-db-lck/5239/2</a></li><li><span id=footnote--9>[9]</span>: <a href=https://wiki.archlinux.org/title/GRUB>https://wiki.archlinux.org/title/GRUB</a></li></ul></article></section><footer id=footer><div class=separated-items><span class=separated-item>Â© 2024</span>
<span class=separated-item><a href=https://github.com/EdmundGoodman>Edmund Goodman</a>
</span><span class=separated-item><a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></span></div></footer></body></html>